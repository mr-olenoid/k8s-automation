kubeadm init --apiserver-cert-extra-sans={{ additional_san }} --pod-network-cidr=10.244.0.0/16 
kubectl set env daemonset/calico-node -n kube-system IP_AUTODETECTION_METHOD=interface=eth1

kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

--apiserver-advertise-address

- name: new certificates for bootstraping
  become: yes
  shell: kubeadm init phase upload-certs --upload-certs --kubeconfig=/etc/kubernetes/admin.conf
  run_once: true
  register: certificate_key
  when:
    - inventory_hostname in groups['k8s_masters']
    - inventory_hostname == play_hosts[0]

- debug: msg="{{ certificate_key.stdout_lines[-1] }}"

- name: Generate join command for masters
  become: yes
  shell: "kubeadm token create --certificate-key {{ certificate_key.stdout_lines[-1] }} --print-join-command --kubeconfig=/etc/kubernetes/admin.conf"
  register: join_masters_command
  run_once: true
  when:
    - inventory_hostname in groups['k8s_masters']
    - inventory_hostname == play_hosts[0]

- debug: msg="{{ join_masters_command }}"

- name: Join masters to clusters
  become: yes
  shell: "{{ join_masters_command.stdout }} --apiserver-advertise-address {{ inventory_hostname }}"
  when:
    - inventory_hostname in groups['k8s_masters']
    - inventory_hostname != play_hosts[0]

- name: Generate join command for workers
  become: yes
  shell: kubeadm token create --print-join-command --kubeconfig=/etc/kubernetes/admin.conf
  register: join_worker_command
  run_once: true
  when:
    - inventory_hostname in groups['k8s_masters']
    - inventory_hostname == play_hosts[0]

- name: Join workers to clusters
  become: yes
  shell: "{{ join_worker_command.stdout }}"
  when:
    - inventory_hostname in groups['k8s_workers']
